name: PureStack Data Engineering Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  audit-pipeline:
    runs-on: ubuntu-latest
    name: ğŸ›¢ï¸ ETL Quality Gate

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ” Phase 1 Structural Integrity
        run: |
          echo "::group::File Structure Validation"
          if [ ! -f "src/pipeline.py" ]; then echo "âŒ Missing: src/pipeline.py"; exit 1; fi
          if [ ! -f "src/__init__.py" ]; then echo "âŒ Missing: src/__init__.py"; exit 1; fi
          if [ ! -f "data/sales_raw.csv" ]; then echo "âŒ Missing: data/sales_raw.csv"; exit 1; fi
          if [ ! -f "requirements.txt" ]; then echo "âŒ Missing: requirements.txt"; exit 1; fi
          echo "âœ… Project Structure is valid."
          echo "::endgroup::"

      - name: ğŸ Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pandas

      - name: ğŸ•µï¸ Phase 2 Anti-Pattern Detection
        run: |
          echo "::group::Static Code Analysis"
          if grep -r "print(" src/; then echo "âŒ CRITICAL: 'print()' detected. Use 'logging'."; exit 1; fi
          if grep -r "C:/" src/; then echo "âŒ CRITICAL: Absolute path 'C:/' detected."; exit 1; fi
          if grep -r "/Users/" src/; then echo "âŒ CRITICAL: Absolute path '/Users/' detected."; exit 1; fi
          echo "âœ… Code adheres to Engineering Standards."
          echo "::endgroup::"

      - name: ğŸ§ª Phase 3 Data Integrity Validation
        run: pytest tests/ -v
